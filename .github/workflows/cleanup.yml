# cleans up preview pages on pull request close

name: "cleanup preview site"

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout out respository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: cleanup PR previews when PR closed
        if: github.event_name == 'pull_request' && github.event.action == 'closed'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin gh-pages || true
          if git ls-remote --exit-code --heads origin gh-pages; then
              git checkout gh-pages
          else
              echo "No gh-pages branch exists on origin; nothing to clean."
              exit 0
          fi

          PR_DIR="pr-preview/${{ github.event.pull_request.number }}"
          if [ -d "$PR_DIR" ]; then
              git rm -r --ignore-unmatch "$PR_DIR"
              if ! git diff --quiet --exit-code; then
              git add -u
              git commit -m "Remove PR preview #${{ github.event.pull_request.number }}"
              git push origin gh-pages
              else
              echo "No changes to commit after removal."
              fi
          else
              echo "No PR preview found for this PR"
          fi
